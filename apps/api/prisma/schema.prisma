generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  USER
}

enum CustomerDocType {
  CC
  CE
  NIT
  PASSPORT
  OTHER
}

enum InventoryMovementType {
  IN
  OUT
  ADJUST
}

enum SaleStatus {
  DRAFT
  PAID
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  SENT
  EXPIRED
  CONVERTED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  VOIDED
}

enum CashMovementType {
  IN
  OUT
  ADJUST
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum DianEnvironment {
  HABILITACION
  PRODUCCION
}

enum DianDocumentType {
  FE
  NC
  ND
}

enum DianDocumentStatus {
  DRAFT
  SIGNED
  SENT
  ACCEPTED
  REJECTED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  RECEIVED
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

enum SupplierInvoiceStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

// ---------- Multi-tenant (RBAC + Plan/módulos, ver docs/ROLES_Y_PERMISOS_DISEÑO.md y ARQUITECTURA_MODULAR_SAAS.md) ----------
model Plan {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  slug            String    @unique
  description     String?
  priceMonthly    Decimal?  @db.Decimal(10, 2)
  priceYearly     Decimal?  @db.Decimal(10, 2)
  stripePriceId   String?   @db.VarChar(255)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  features       PlanFeature[]
  tenants        Tenant[]
  subscriptions  Subscription[]
}

model PlanFeature {
  id         String   @id @default(uuid()) @db.Uuid
  planId     String   @db.Uuid
  moduleCode String
  createdAt  DateTime @default(now())

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, moduleCode])
  @@index([moduleCode])
}

model Tenant {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  slug            String    @unique
  planId          String?   @db.Uuid
  isActive        Boolean   @default(true)
  lastActivityAt  DateTime? @db.Timestamptz
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  plan          Plan?          @relation(fields: [planId], references: [id], onDelete: SetNull)
  subscription  Subscription?
  modules       TenantModule[]
  addOns        TenantAddOn[]
  users         User[]
  roles      Role[]
  userRoles  UserRole[]
  categories               Category[]
  products                 Product[]
  productDictionaryEntries ProductDictionaryEntry[]
  customers                Customer[]
  suppliers  Supplier[]
  sales      Sale[]
  quotes     Quote[]
  invoices   Invoice[]
  purchaseOrders     PurchaseOrder[]
  supplierInvoices   SupplierInvoice[]
  cashSessions       CashSession[]
  expenses           Expense[]
  inventoryMovements InventoryMovement[]
  dianConfigs        DianConfig[]
  auditLogs          AuditLog[]
  backupRuns         BackupRun[]
}

model TenantModule {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  moduleCode String
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleCode])
  @@index([tenantId])
  @@index([moduleCode])
}

model AddOn {
  id           String   @id @default(uuid()) @db.Uuid
  moduleCode   String   @unique
  name         String
  description  String?
  priceMonthly Decimal? @db.Decimal(10, 2)
  priceYearly  Decimal? @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenantAddOns TenantAddOn[]
}

model TenantAddOn {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @db.Uuid
  addOnId    String    @db.Uuid
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  createdAt  DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  addOn  AddOn  @relation(fields: [addOnId], references: [id], onDelete: Cascade)

  @@unique([tenantId, addOnId])
  @@index([tenantId])
  @@index([validUntil])
}

/// Suscripción actual del tenant (estado de pago, periodo). Una por tenant.
model Subscription {
  id                    String             @id @default(uuid()) @db.Uuid
  tenantId              String             @unique @db.Uuid
  planId                String?            @db.Uuid
  status                SubscriptionStatus @default(ACTIVE)
  currentPeriodStart    DateTime?          @db.Timestamptz
  currentPeriodEnd      DateTime?          @db.Timestamptz
  stripeSubscriptionId  String?            @unique @db.VarChar(255)
  lastPaymentFailedAt   DateTime?          @db.Timestamptz
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   Plan?    @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
}

model StripeEvent {
  id         String   @id @default(uuid()) @db.Uuid
  eventId    String   @unique @db.VarChar(255) // Stripe event.id
  type       String   @db.VarChar(100)
  processedAt DateTime @default(now())
  payload    Json     // Evento completo de Stripe para auditoría

  @@index([eventId])
  @@index([processedAt])
  @@index([type])
}

model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String
  description String?
  tenantId    String?  @db.Uuid
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant        Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions   RolePermission[]
  userRoles     UserRole[]

  @@unique([slug, tenantId])
  @@index([tenantId])
}

model RolePermission {
  roleId       String @db.Uuid
  permissionId String @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  roleId    String   @db.Uuid
  tenantId  String?  @db.Uuid
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, tenantId])
  @@index([userId])
  @@index([roleId])
  @@index([tenantId])
}

model User {
  id                     String    @id @default(uuid()) @db.Uuid
  email                  String    @unique
  name                   String?   // Nombre real para mostrar en listas y perfil
  passwordHash           String
  role                   RoleName  @default(USER)
  tenantId               String?   @db.Uuid
  isActive               Boolean   @default(true)
  mustChangePassword     Boolean   @default(false)
  lastLoginAt            DateTime? @db.Timestamptz
  onboardingStatus       String?   @db.VarChar(32)
  onboardingCompletedAt  DateTime? @db.Timestamptz
  profilePictureUrl      String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  tenant    Tenant?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  userRoles UserRole[]
  auditLogs AuditLog[]
  sales     Sale[]
}

model Category {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products            Product[]
  dictionaryEntries   ProductDictionaryEntry[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Product {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid
  internalCode String
  name         String
  categoryId   String?  @db.Uuid
  cost         Decimal  @db.Decimal(18, 2)
  price        Decimal  @db.Decimal(18, 2)
  taxRate      Decimal  @db.Decimal(5, 2) @default(0)
  /// Stock mínimo por producto; si es null se usa el umbral global para alertas de stock bajo.
  minStock     Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])
  stock    StockBalance?

  saleItems              SaleItem[]
  saleReturnItems        SaleReturnItem[]
  quoteItems             QuoteItem[]
  inventoryMovementItems InventoryMovementItem[]
  purchaseOrderItems     PurchaseOrderItem[]
  dictionaryEntries      ProductDictionaryEntry[]

  @@unique([tenantId, internalCode])
  @@index([tenantId])
  @@index([name])
  @@index([categoryId])
  @@index([isActive])
  @@index([createdAt])
}

/// Términos o frases que los clientes escriben al preguntar por productos (sinónimos, búsquedas frecuentes).
model ProductDictionaryEntry {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  term       String   @db.VarChar(200)
  productId  String?  @db.Uuid
  categoryId String?  @db.Uuid
  createdAt  DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product  Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([term])
  @@index([productId])
  @@index([categoryId])
}

model StockBalance {
  productId   String   @id @db.Uuid
  qtyOnHand   Int      @default(0)
  qtyReserved Int      @default(0)
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model InventoryMovement {
  id         String                @id @default(uuid()) @db.Uuid
  tenantId   String                @db.Uuid
  type       InventoryMovementType
  reason     String?
  supplierId String?               @db.Uuid
  createdBy  String?               @db.Uuid
  createdAt  DateTime              @default(now())

  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier?  @relation(fields: [supplierId], references: [id])
  items    InventoryMovementItem[]

  @@index([tenantId])
  @@index([createdAt])
  @@index([type])
  @@index([createdBy])
  @@index([supplierId])
}

model InventoryMovementItem {
  id          String   @id @default(uuid()) @db.Uuid
  movementId  String   @db.Uuid
  productId   String   @db.Uuid
  qty         Int
  unitCost    Decimal? @db.Decimal(18, 2)
  createdAt   DateTime @default(now())

  movement InventoryMovement @relation(fields: [movementId], references: [id], onDelete: Cascade)
  product  Product           @relation(fields: [productId], references: [id])

  @@index([movementId])
  @@index([productId])
}

model Customer {
  id        String          @id @default(uuid()) @db.Uuid
  tenantId  String          @db.Uuid
  docType   CustomerDocType
  docNumber String
  name      String
  email     String?
  phone     String?
  address   String?
  cityCode  String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sales    Sale[]
  quotes   Quote[]
  invoices Invoice[]

  @@unique([tenantId, docType, docNumber])
  @@index([tenantId])
  @@index([name])
}

model Supplier {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  nit         String
  name        String
  description String?
  email       String?
  phone       String?
  address     String?
  cityCode    String?
  contactPerson String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryMovements   InventoryMovement[]
  purchaseOrders       PurchaseOrder[]
  invoices             SupplierInvoice[]

  @@unique([tenantId, nit])
  @@index([tenantId])
  @@index([name])
  @@index([nit])
  @@index([isActive])
}

model PurchaseOrder {
  id            String              @id @default(uuid()) @db.Uuid
  tenantId      String              @db.Uuid
  supplierId    String              @db.Uuid
  orderNumber   String
  status        PurchaseOrderStatus @default(DRAFT)
  orderDate     DateTime            @default(now())
  expectedDate  DateTime?
  receivedDate  DateTime?
  notes         String?
  subtotal      Decimal             @db.Decimal(18, 2) @default(0)
  taxTotal      Decimal             @db.Decimal(18, 2) @default(0)
  discountTotal Decimal             @db.Decimal(18, 2) @default(0)
  grandTotal    Decimal             @db.Decimal(18, 2) @default(0)
  createdBy     String?             @db.Uuid
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]
  invoices SupplierInvoice[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@index([expectedDate])
}

model PurchaseOrderItem {
  id            String   @id @default(uuid()) @db.Uuid
  purchaseOrderId String  @db.Uuid
  productId     String   @db.Uuid
  qty           Int
  unitCost      Decimal  @db.Decimal(18, 2)
  taxRate       Decimal  @db.Decimal(5, 2) @default(0)
  lineTotal     Decimal  @db.Decimal(18, 2)
  receivedQty   Int      @default(0)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
}

model SupplierInvoice {
  id            String                @id @default(uuid()) @db.Uuid
  tenantId      String                @db.Uuid
  supplierId    String                @db.Uuid
  purchaseOrderId String?             @db.Uuid
  invoiceNumber String
  invoiceDate   DateTime              @default(now())
  dueDate       DateTime
  status        SupplierInvoiceStatus @default(PENDING)
  subtotal      Decimal               @db.Decimal(18, 2) @default(0)
  taxTotal      Decimal               @db.Decimal(18, 2) @default(0)
  discountTotal Decimal               @db.Decimal(18, 2) @default(0)
  grandTotal    Decimal               @db.Decimal(18, 2) @default(0)
  paidAmount    Decimal               @db.Decimal(18, 2) @default(0)
  notes         String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier      Supplier        @relation(fields: [supplierId], references: [id])
  purchaseOrder PurchaseOrder?   @relation(fields: [purchaseOrderId], references: [id])
  payments      SupplierPayment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([purchaseOrderId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
}

model SupplierPayment {
  id              String        @id @default(uuid()) @db.Uuid
  supplierInvoiceId String      @db.Uuid
  amount          Decimal       @db.Decimal(18, 2)
  paymentDate     DateTime      @default(now())
  paymentMethod   PaymentMethod
  reference       String?
  notes           String?
  createdBy       String?       @db.Uuid
  createdAt       DateTime      @default(now())

  supplierInvoice SupplierInvoice @relation(fields: [supplierInvoiceId], references: [id], onDelete: Cascade)

  @@index([supplierInvoiceId])
  @@index([paymentDate])
}

model Sale {
  id            String     @id @default(uuid()) @db.Uuid
  tenantId      String     @db.Uuid
  customerId    String?    @db.Uuid
  createdByUserId String?  @db.Uuid
  status        SaleStatus @default(DRAFT)
  soldAt        DateTime   @default(now())
  subtotal      Decimal    @db.Decimal(18, 2) @default(0)
  taxTotal      Decimal    @db.Decimal(18, 2) @default(0)
  discountTotal Decimal    @db.Decimal(18, 2) @default(0)
  grandTotal    Decimal    @db.Decimal(18, 2) @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer  Customer? @relation(fields: [customerId], references: [id])
  createdBy User?     @relation(fields: [createdByUserId], references: [id])
  items     SaleItem[]
  returns   SaleReturn[]

  cashMovements CashMovement[]
  invoices      Invoice[]

  @@index([tenantId])
  @@index([soldAt])
  @@index([tenantId, soldAt])
  @@index([customerId])
  @@index([status])
  @@index([createdByUserId])
}

model SaleReturn {
  id         String   @id @default(uuid()) @db.Uuid
  saleId     String   @db.Uuid
  returnedAt DateTime @default(now())
  reason     String?
  subtotal   Decimal  @db.Decimal(18, 2) @default(0)
  taxTotal   Decimal  @db.Decimal(18, 2) @default(0)
  grandTotal Decimal  @db.Decimal(18, 2) @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sale  Sale            @relation(fields: [saleId], references: [id], onDelete: Restrict)
  items SaleReturnItem[]

  @@index([saleId])
  @@index([returnedAt])
}

model SaleReturnItem {
  id           String   @id @default(uuid()) @db.Uuid
  saleReturnId String   @db.Uuid
  productId    String   @db.Uuid
  qty          Int
  unitPrice    Decimal  @db.Decimal(18, 2)
  lineTotal    Decimal  @db.Decimal(18, 2)

  saleReturn SaleReturn @relation(fields: [saleReturnId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([saleReturnId])
  @@index([productId])
}

model SaleItem {
  id        String   @id @default(uuid()) @db.Uuid
  saleId    String   @db.Uuid
  productId String   @db.Uuid
  qty       Int
  unitPrice Decimal  @db.Decimal(18, 2)
  taxRate   Decimal  @db.Decimal(5, 2) @default(0)
  lineTotal Decimal  @db.Decimal(18, 2)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
}

model CashSession {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  openedAt      DateTime @default(now())
  closedAt      DateTime?
  openingAmount Decimal  @db.Decimal(18, 2) @default(0)
  closingAmount Decimal  @db.Decimal(18, 2) @default(0)
  openedBy      String?  @db.Uuid
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  movements CashMovement[]
  expenses  Expense[]

  @@index([tenantId])
  @@index([openedAt])
  @@index([closedAt])
}

model Expense {
  id            String        @id @default(uuid()) @db.Uuid
  tenantId      String        @db.Uuid
  amount        Decimal       @db.Decimal(18, 2)
  description   String
  category      String?
  expenseDate   DateTime      @default(now())
  paymentMethod PaymentMethod
  cashSessionId String?       @db.Uuid
  reference     String?
  createdBy     String?       @db.Uuid
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashSession CashSession?   @relation(fields: [cashSessionId], references: [id], onDelete: SetNull)
  cashMovement CashMovement?

  @@index([tenantId])
  @@index([expenseDate])
  @@index([cashSessionId])
  @@index([category])
}

model CashMovement {
  id               String           @id @default(uuid()) @db.Uuid
  sessionId        String           @db.Uuid
  type             CashMovementType
  method           PaymentMethod
  amount           Decimal          @db.Decimal(18, 2)
  reference        String?
  relatedSaleId    String?          @db.Uuid
  relatedExpenseId String?          @unique @db.Uuid
  createdAt        DateTime         @default(now())

  session      CashSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  relatedSale  Sale?       @relation(fields: [relatedSaleId], references: [id])
  relatedExpense Expense? @relation(fields: [relatedExpenseId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@index([relatedSaleId])
}

model Quote {
  id            String      @id @default(uuid()) @db.Uuid
  tenantId      String      @db.Uuid
  customerId    String?     @db.Uuid
  status        QuoteStatus @default(DRAFT)
  validUntil    DateTime?
  subtotal      Decimal     @db.Decimal(18, 2) @default(0)
  taxTotal      Decimal     @db.Decimal(18, 2) @default(0)
  discountTotal Decimal     @db.Decimal(18, 2) @default(0)
  grandTotal    Decimal     @db.Decimal(18, 2) @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id])
  items    QuoteItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, validUntil])
  @@index([createdAt])
  @@index([customerId])
  @@index([status])
}

model QuoteItem {
  id        String   @id @default(uuid()) @db.Uuid
  quoteId   String   @db.Uuid
  productId String   @db.Uuid
  qty       Int
  unitPrice Decimal  @db.Decimal(18, 2)
  taxRate   Decimal  @db.Decimal(5, 2) @default(0)
  lineTotal Decimal  @db.Decimal(18, 2)

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([quoteId])
  @@index([productId])
}

model Invoice {
  id            String        @id @default(uuid()) @db.Uuid
  tenantId      String        @db.Uuid
  saleId        String?       @db.Uuid
  customerId    String?       @db.Uuid
  number        String
  issuedAt      DateTime      @default(now())
  status        InvoiceStatus @default(DRAFT)
  subtotal      Decimal       @db.Decimal(18, 2) @default(0)
  taxTotal      Decimal       @db.Decimal(18, 2) @default(0)
  discountTotal Decimal       @db.Decimal(18, 2) @default(0)
  grandTotal    Decimal       @db.Decimal(18, 2) @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sale     Sale?      @relation(fields: [saleId], references: [id])
  customer Customer?  @relation(fields: [customerId], references: [id])

  dianDocument DianDocument?

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([issuedAt])
  @@index([customerId])
  @@index([saleId])
}

/// Configuración DIAN por tenant (una por empresa). Certificado y PIN se almacenan cifrados.
model DianConfig {
  id                   String           @id @default(uuid()) @db.Uuid
  tenantId              String           @db.Uuid
  env                   DianEnvironment  @default(HABILITACION)
  /// NIT del emisor (empresa). Obligatorio para XML y validación DIAN.
  issuerNit             String?
  /// Razón social del emisor.
  issuerName            String?
  softwareId            String?
  /// PIN DIAN; en producción debería almacenarse cifrado (certPasswordEncrypted o gestor de secretos).
  softwarePin           String?
  resolutionNumber      String?
  prefix                String?
  rangeFrom             Int?
  rangeTo               Int?
  /// Contenido del .p12 cifrado (AES-256), en base64. Clave: DIAN_CERT_ENCRYPTION_KEY.
  certEncrypted         String?          @db.Text
  /// Contraseña del .p12 cifrada (AES-256), en base64.
  certPasswordEncrypted String?          @db.Text
  /// Fecha de vencimiento del certificado (cacheada del .p12) para validaciones sin abrir el archivo.
  certValidUntil        DateTime?        @db.Timestamptz
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId])
  @@index([tenantId])
}

model DianDocument {
  id        String            @id @default(uuid()) @db.Uuid
  invoiceId String            @unique @db.Uuid
  type      DianDocumentType  @default(FE)
  cufe      String?
  xmlPath   String?
  pdfPath   String?
  status    DianDocumentStatus @default(DRAFT)
  lastError String?
  sentAt    DateTime?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  events  DianEvent[]

  @@index([status])
  @@index([sentAt])
  @@index([createdAt])
}

model DianEvent {
  id            String   @id @default(uuid()) @db.Uuid
  dianDocumentId String  @db.Uuid
  eventType     String
  payload       Json
  createdAt     DateTime @default(now())

  dianDocument DianDocument @relation(fields: [dianDocumentId], references: [id], onDelete: Cascade)

  @@index([dianDocumentId])
  @@index([createdAt])
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String?  @db.Uuid
  actorId      String?  @db.Uuid
  entity       String
  entityId     String
  action       String
  summary      String?  @db.VarChar(255)
  diff         Json?
  requestId    String?  @db.VarChar(64)
  ip           String?  @db.VarChar(45)
  userAgent    String?  @db.VarChar(500)
  severity     String?  @db.VarChar(20)
  category     String?  @db.VarChar(20)
  createdAt    DateTime @default(now())
  previousHash String?  @db.VarChar(64)
  entryHash    String?  @db.VarChar(64)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  actor  User?   @relation(fields: [actorId], references: [id])

  @@index([tenantId])
  @@index([createdAt])
  @@index([entity, entityId])
  @@index([actorId])
  @@index([action])
  @@index([severity])
  @@index([category])
  @@index([requestId])
}

model BackupRun {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  startedAt   DateTime @default(now())
  finishedAt DateTime?
  status      String
  storagePath String?
  checksum    String?
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([startedAt])
  @@index([status])
}
